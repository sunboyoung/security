<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zms.dao.user.UserDao">


    <!-- 创建用户 -->
    <insert id="createUser" parameterType="user" useGeneratedKeys="true" keyProperty="id">
        insert into sys_users values (null,#{username},#{password},#{salt},0)
    </insert>

    <!-- 更新用户信息 -->
    <update id="updateUser" parameterType="user">
        update sys_users
        <set>
            <if test="username!=null and username!= '' ">
                username=#{username}
            </if>
            <if test="password!=null and password!= '' ">
                password=#{password}
            </if>
            <if test="salt!=null and salt!= '' ">
                salt=#{salt}
            </if>
            <if test="locked!=null and locked.equals('false')">
                locked=0
            </if>
            <if test="locked!=null and locked.equals('true')">
                locked=1
            </if>
        </set>
        where id=#{id}
    </update>

    <!-- 删除用户信息 -->
    <delete id="deleteUser" parameterType="long">
        delete from sys_users where id=#{id}
    </delete>

    <!-- 添加用户角色信息-->
    <insert id="correlationRoles">
        insert into sys_users_roles(user_id,role_id) values (#{userId},#{roleIds})
    </insert>


    <!-- 删除用户角色信息 -->
    <delete id="uncorrelationRoles">
        delete from sys_users_roles where user_id=#{userId} and role_id=#{roleIds}
    </delete>

    <!-- 根据userId查出用户信息 -->
    <select id="findOne" parameterType="long" resultType="user">
        select * from sys_users where id=#{userId}
    </select>

    <!-- 根据用户名查出用户信息 -->
    <select id="findByUsername" parameterType="String" resultType="user">
        select * from sys_user where username=#{username}
    </select>

    <!-- 根据用户名查询出角色信息 -->
    <select id="findRoles" parameterType="String" resultType="String">
        SELECT r.role FROM sys_role r
        LEFT JOIN sys_user_role ur
        ON r.id=ur.role_id
        LEFT JOIN sys_user u
        ON u.id=ur.user_id
        WHERE u.username=#{username}
    </select>

    <!-- 根据用户名查询权限信息 -->
    <select id="findPermissions" parameterType="String" resultType="String">
        select p.permission from sys_permission p
        left join sys_resource_permission rp
        on rp.permission_id=p.id
        left join sys_role_resource rr
        on rr.resource_id =rp.resource_id
        left join sys_user_role ur
        on ur.role_id =rr.role_id
        left join sys_user u
        on u.id=ur.user_id
        where u.username=#{userName}
    </select>

    <!-- 获取所有的用户列表 -->
    <select id="getUserListByPage" resultType="java.util.HashMap">
        select u.id as id
        ,u.username as userName
        ,r.role as role
        ,r.description as description
        from sys_user u
        left join sys_user_role ur
        on ur.user_id=u.id
        left join sys_role r
        on r.id=ur.role_id
    </select>
</mapper>
